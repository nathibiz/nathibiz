<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Business & Financial Tracker</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon-192x192.png">
  <link rel="apple-touch-icon" href="/icon-512x512.png">
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f3f4f6; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h2, h3 { color: #1f2937; }
    input, button { margin: 10px 0; padding: 8px; width: calc(100% - 18px); border: 1px solid #d1d5db; border-radius: 4px; box-sizing: border-box; }
    button { background-color: #4b5563; color: white; cursor: pointer; }
    button:hover { background-color: #374151; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #d1d5db; padding: 8px; text-align: left; }
    th { background-color: #f9fafb; }
    .conditional { display: none; }
    #debugInfo { color: #666; font-size: 12px; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <section id="auth">
      <h2>Sign In</h2>
      <div id="debugInfo"></div>
      <form id="signInForm">
        <input type="email" id="signInEmail" placeholder="Email" required><br>
        <input type="password" id="signInPassword" placeholder="Password" required><br>
        <button type="submit" id="signInButton">Sign In</button>
      </form>
      <p>Don't have an account? <a href="#" id="showRegister">Register</a></p>
      <p>Forgot password? <a href="#" id="resetPassword">Reset Password</a></p>
    </section>

    <section id="register" class="hidden">
      <h2>Register</h2>
      <form id="registerForm">
        <input type="email" id="registerEmail" placeholder="Email" required><br>
        <input type="password" id="registerPassword" placeholder="Password" required><br>
        <button type="submit">Register</button>
      </form>
      <p>Already have an account? <a href="#" id="showSignIn">Sign In</a></p>
    </section>

    <section id="businessRegistration" class="hidden">
      <h2>Register Your Business</h2>
      <form id="businessForm">
        <input type="text" id="ownerName" placeholder="Owner Name" required><br>
        <input type="text" id="ownerId" placeholder="ID/Passport Number" required><br>
        <input type="tel" id="ownerContactNumber" placeholder="Contact Number (e.g., +27xxxxxxxxx)" required><br>
        <input type="text" id="residentialAddress" placeholder="Residential Address" required><br>
        <input type="text" id="businessName" placeholder="Business Name" required><br>
        <input type="tel" id="businessContactNumber" placeholder="Business Contact Number (e.g., +27xxxxxxxxx)" required><br>
        <select id="businessType" required>
          <option value="" disabled selected>Select Business Type</option>
          <option value="Spaza/Tuck shop">Spaza/Tuck shop</option>
          <option value="Supermarket">Supermarket</option>
          <option value="Fast Food">Fast Food</option>
          <option value="Street hawker/vendor">Street hawker/vendor</option>
          <option value="Salon/Barber">Salon/Barber</option>
          <option value="Car Wash">Car Wash</option>
          <option value="Home Based Business">Home Based Business</option>
          <option value="Informal transport">Informal transport</option>
          <option value="Other">Other</option>
        </select><br>
        <input type="text" id="businessTypeOther" placeholder="Specify Business Type" class="conditional"><br>
        <input type="text" id="businessAddress" placeholder="Business Address" required><br>
        <input type="text" id="googleMapsUrl" placeholder="Location for Business (Google Maps URL, e.g., https://www.google.com/maps/place/...)"><br>
        <button type="button" onclick="getCurrentLocation()">Send Your Location</button><br>
        <input type="text" id="municipalityName" placeholder="Municipality Name" required><br>
        <input type="number" id="operationYears" placeholder="Years in Operation" min="0" required><br>
        <input type="number" id="operationMonths" placeholder="Months in Operation" min="0" max="11" required><br>
        <select id="hasBusinessAccount" required>
          <option value="" disabled selected>Do you have a business account?</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select><br>
        <select id="bankName" class="conditional">
          <option value="" disabled selected>Select Bank</option>
          <option value="ABSA">ABSA</option>
          <option value="Bidvest">Bidvest</option>
          <option value="Capitec">Capitec</option>
          <option value="FNB">FNB</option>
          <option value="Nedbank">Nedbank</option>
          <option value="Standard Bank">Standard Bank</option>
          <option value="TymeBank">TymeBank</option>
        </select><br>
        <button type="submit">Register Business</button>
      </form>
    </section>

    <section id="dashboard" class="hidden">
      <h2>Dashboard</h2>
      <button onclick="signOut()">Sign Out</button>
      <h3>Business Details</h3>
      <div id="businessDetails"></div>
      <div id="businessMap" style="margin-top: 20px;">
        <iframe id="mapIframe" width="100%" height="300" frameborder="0" style="border:0" allowfullscreen></iframe>
      </div>
      <h3>Track Sales and Expenses</h3>
      <form id="salesForm">
        <input type="number" id="saleAmount" placeholder="Sale Amount" required step="0.01"><br>
        <input type="number" id="saleCost" placeholder="Cost of Sale" required step="0.01"><br>
        <input type="date" id="saleDate" required><br>
        <button type="submit">Add Sale</button>
      </form>
      <form id="expensesForm">
        <input type="number" id="expenseAmount" placeholder="Expense Amount" required step="0.01"><br>
        <input type="text" id="expenseCategory" placeholder="Category (e.g., Utilities)" required><br>
        <input type="date" id="expenseDate" required><br>
        <button type="submit">Add Expense</button>
      </form>
      <h3>Reports</h3>
      <select id="reportPeriod">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
      </select>
      <button onclick="generateReport()">Generate Report</button>
      <div id="reportOutput"></div>
      <h3>Tax Estimation</h3>
      <input type="month" id="taxMonth" required>
      <button onclick="estimateTax()">Estimate Tax</button>
      <div id="taxOutput"></div>
      <h3>Export Data</h3>
      <button onclick="exportToCSV()">Export to CSV</button>
      <h3>Funding</h3>
      <p>Funding application feature coming soon.</p>
    </section>
  </div>

  <script>
    // Global error handler
    window.onerror = function(msg, url, line, col, error) {
      console.error('Global error:', msg, 'at', url, line + ':' + col, error);
      alert('Unexpected error: ' + msg);
      return false;
    };

    console.log('Script loaded at:', new Date().toISOString());
    document.getElementById('debugInfo').innerText = `Script loaded at ${new Date().toLocaleString()}`;

    const firebaseConfig = {
      apiKey: "AIzaSyBjop9idbdOohdUtDvztaPmlLk-w4Xiy3c",
      authDomain: "nathibiz.firebaseapp.com",
      projectId: "nathibiz",
      storageBucket: "nathibiz.appspot.com",
      messagingSenderId: "585170233799",
      appId: "1:585170233799:web:e79c3b9f334d23343b91e2"
    };

    try {
      console.log('Initializing Firebase');
      firebase.initializeApp(firebaseConfig);
      console.log('Firebase initialized, version:', firebase.SDK_VERSION);
      document.getElementById('debugInfo').innerText += `\nFirebase v${firebase.SDK_VERSION} initialized`;
    } catch (error) {
      console.error('Firebase init error:', error);
      alert('Firebase initialization failed: ' + error.message);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    let isProcessing = false; // Debounce flag

    function showSection(sectionId) {
      console.log('Showing section:', sectionId);
      document.querySelectorAll('section').forEach(section => section.classList.add('hidden'));
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.remove('hidden');
        if (sectionId === 'dashboard') {
          loadBusinessDetails();
          loadSalesAndExpenses();
        }
      } else {
        console.error('Section not found:', sectionId);
        alert('Error: Section ' + sectionId + ' not found');
      }
    }

    auth.onAuthStateChanged(user => {
      console.log('Auth state changed:', user ? `User ${user.uid}, Email: ${user.email}` : 'No user');
      document.getElementById('debugInfo').innerText += `\nAuth state: ${user ? 'Signed in as ' + user.email : 'No user'}`;
      if (user) {
        let attempts = 0;
        const maxAttempts = 3;
        const checkBusiness = () => {
          setTimeout(() => {
            firebase.firestore().getDoc(firebase.firestore().doc(db, 'businesses', user.uid)).then(doc => {
              console.log('Business check result:', doc.exists());
              document.getElementById('debugInfo').innerText += `\nBusiness check: ${doc.exists() ? 'Exists' : 'Not found'}`;
              showSection(doc.exists() ? 'dashboard' : 'businessRegistration');
            }).catch(error => {
              console.error('Error checking business:', error);
              document.getElementById('debugInfo').innerText += `\nBusiness check error: ${error.message}`;
              if (attempts < maxAttempts) {
                attempts++;
                checkBusiness(); // Retry
              } else {
                alert('Failed to load business data after retries: ' + error.message);
                showSection('businessRegistration');
                window.location.reload();
              }
            });
          }, 1000);
        };
        checkBusiness();
      } else {
        showSection('auth');
      }
    });

    console.log('Setting up event listeners');
    const signInForm = document.getElementById('signInForm');
    const signInButton = document.getElementById('signInButton');
    const debugInfo = document.getElementById('debugInfo');

    if (!signInForm) {
      console.error('signInForm not found');
      alert('Critical error: Sign In form not found');
    } else {
      console.log('signInForm found');
      debugInfo.innerText += '\nSign In form detected';
    }

    if (!signInButton) {
      console.error('signInButton not found');
      alert('Critical error: Sign In button not found');
    } else {
      console.log('signInButton found');
      debugInfo.innerText += '\nSign In button detected';
    }

    if (signInForm) {
      signInForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isProcessing) return;
        isProcessing = true;
        console.log('Sign In form submitted');
        debugInfo.innerText += '\nForm submitted';
        alert('Sign In form submitted');
        await handleSignIn();
        isProcessing = false;
      });
    }

    if (signInButton) {
      signInButton.addEventListener('click', async (e) => {
        e.preventDefault();
        if (isProcessing) return;
        isProcessing = true;
        console.log('Sign In button clicked');
        debugInfo.innerText += '\nButton clicked';
        alert('Sign In button clicked');
        await handleSignIn();
        isProcessing = false;
      });
    }

    async function handleSignIn() {
      const emailInput = document.getElementById('signInEmail');
      const passwordInput = document.getElementById('signInPassword');
      if (!emailInput || !passwordInput) {
        console.error('Email or password input missing');
        alert('Error: Email or password input not found');
        return;
      }
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      console.log('Email:', email, 'Password length:', password.length);
      debugInfo.innerText += `\nAttempting email sign-in\nEmail: ${email}`;
      if (!email) {
        console.warn('Email empty');
        alert('Please enter an email');
        return;
      }
      if (!password) {
        console.warn('Password empty');
        alert('Please enter a password');
        return;
      }
      if (!/\S+@\S+\.\S+/.test(email)) {
        console.warn('Invalid email:', email);
        alert('Please enter a valid email');
        return;
      }
      console.log('Calling signInWithEmailAndPassword');
      debugInfo.innerText += '\nCalling Firebase email auth';
      alert('Attempting email sign-in');
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        console.log('Email sign-in successful, UID:', userCredential.user.uid);
        debugInfo.innerText += `\nEmail sign-in successful, UID: ${userCredential.user.uid}`;
        alert('Signed in successfully');
      } catch (error) {
        console.error('Sign-in error:', error.code, error.message, error.stack);
        debugInfo.innerText += `\nError: ${error.message}`;
        alert('Sign-in failed: ' + error.message);
      }
    }

    const showRegisterLink = document.getElementById('showRegister');
    const showSignInLink = document.getElementById('showSignIn');
    const resetPasswordLink = document.getElementById('resetPassword');
    if (showRegisterLink) {
      showRegisterLink.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Show Register clicked');
        showSection('register');
      });
    }
    if (showSignInLink) {
      showSignInLink.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Show Sign In clicked');
        showSection('auth');
      });
    }
    if (resetPasswordLink) {
      resetPasswordLink.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Reset Password clicked');
        const email = document.getElementById('signInEmail').value.trim();
        if (!email) {
          alert('Please enter your email to reset password');
          return;
        }
        auth.sendPasswordResetEmail(email).then(() => {
          console.log('Password reset email sent:', email);
          alert('Password reset email sent. Check your inbox.');
        }).catch(error => {
          console.error('Password reset error:', error);
          alert('Password reset failed: ' + error.message);
        });
      });
    }

    const registerForm = document.getElementById('registerForm');
    if (registerForm) {
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Register form submitted');
        const emailInput = document.getElementById('registerEmail');
        const passwordInput = document.getElementById('registerPassword');
        if (!emailInput || !passwordInput) {
          console.error('Email or password input missing');
          alert('Error: Email or password input not found');
          return;
        }
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        console.log('Email:', email);
        if (!email) {
          console.warn('Email empty');
          alert('Please enter an email');
          return;
        }
        if (!password) {
          console.warn('Password empty');
          alert('Please enter a password');
          return;
        }
        if (!/\S+@\S+\.\S+/.test(email)) {
          console.warn('Invalid email:', email);
          alert('Please enter a valid email');
          return;
        }
        console.log('Calling createUserWithEmailAndPassword');
        try {
          await auth.createUserWithEmailAndPassword(email, password);
          console.log('Email registration successful');
          alert('Registered successfully');
        } catch (error) {
          console.error('Registration error:', error.code, error.message, error.stack);
          alert('Registration failed: ' + error.message);
        }
      });
    }

    const businessTypeSelect = document.getElementById('businessType');
    if (businessTypeSelect) {
      businessTypeSelect.addEventListener('change', (e) => {
        console.log('Business Type changed:', e.target.value);
        const otherField = document.getElementById('businessTypeOther');
        const isOther = e.target.value === 'Other';
        otherField.classList.toggle('conditional', !isOther);
        otherField.style.display = isOther ? 'block' : 'none';
        otherField.required = isOther;
      });
    }

    const hasBusinessAccountSelect = document.getElementById('hasBusinessAccount');
    if (hasBusinessAccountSelect) {
      hasBusinessAccountSelect.addEventListener('change', (e) => {
        console.log('Has Business Account changed:', e.target.value);
        const bankField = document.getElementById('bankName');
        const isYes = e.target.value === 'Yes';
        bankField.classList.toggle('conditional', !isYes);
        bankField.style.display = isYes ? 'block' : 'none';
        bankField.required = isYes;
      });
    }

    const businessForm = document.getElementById('businessForm');
    if (businessForm) {
      businessForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Register Business form submitted');
        const ownerName = document.getElementById('ownerName').value.trim();
        const ownerId = document.getElementById('ownerId').value.trim();
        const ownerContactNumber = document.getElementById('ownerContactNumber').value.trim();
        const residentialAddress = document.getElementById('residentialAddress').value.trim();
        const businessName = document.getElementById('businessName').value.trim();
        const businessContactNumber = document.getElementById('businessContactNumber').value.trim();
        let businessType = document.getElementById('businessType').value;
        const businessTypeOther = document.getElementById('businessTypeOther').value.trim();
        const businessAddress = document.getElementById('businessAddress').value.trim();
        let googleMapsUrl = document.getElementById('googleMapsUrl').value.trim();
        const municipalityName = document.getElementById('municipalityName').value.trim();
        const operationYears = parseInt(document.getElementById('operationYears').value);
        const operationMonths = parseInt(document.getElementById('operationMonths').value);
        const hasBusinessAccount = document.getElementById('hasBusinessAccount').value;
        const bankName = document.getElementById('bankName').value;
        const user = auth.currentUser;

        try {
          if (businessType === 'Other' && !businessTypeOther) {
            console.warn('Business type Other selected but no specification provided');
            alert('Please specify the business type.');
            return;
          }
          if (hasBusinessAccount === 'Yes' && !bankName) {
            console.warn('Business account Yes selected but no bank provided');
            alert('Please select a bank.');
            return;
          }
          if (!/^\+\d{10,15}$/.test(ownerContactNumber)) {
            console.warn('Invalid owner contact number:', ownerContactNumber);
            alert('Please enter a valid owner contact number starting with + (e.g., +27xxxxxxxxx).');
            return;
          }
          if (!/^\+\d{10,15}$/.test(businessContactNumber)) {
            console.warn('Invalid business contact number:', businessContactNumber);
            alert('Please enter a valid business contact number starting with + (e.g., +27xxxxxxxxx).');
            return;
          }
          if (!municipalityName) {
            console.warn('Municipality name is empty');
            alert('Please enter a municipality name.');
            return;
          }

          const embedUrl = getEmbedUrl(googleMapsUrl);
          if (googleMapsUrl && !embedUrl) {
            console.warn('Invalid Google Maps URL:', googleMapsUrl);
          }

          if (user) {
            console.log('Saving business data for user:', user.uid);
            await firebase.firestore().setDoc(firebase.firestore().doc(db, 'businesses', user.uid), {
              ownerName,
              ownerId,
              ownerContactNumber,
              residentialAddress,
              businessName,
              businessContactNumber,
              businessType: businessType === 'Other' ? businessTypeOther : businessType,
              businessAddress,
              googleMapsUrl,
              embedUrl,
              municipalityName,
              operationYears,
              operationMonths,
              hasBusinessAccount,
              bankName: hasBusinessAccount === 'Yes' ? bankName : null,
              userId: user.uid
            });
            console.log('Business data saved successfully');
            alert('Business registered successfully!');
            showSection('dashboard');
          } else {
            console.warn('No authenticated user');
            alert('Please sign in to register a business.');
          }
        } catch (error) {
          console.error('Business registration error:', error);
          alert('Error registering business: ' + error.message);
        }
      });
    }

    const salesForm = document.getElementById('salesForm');
    if (salesForm) {
      salesForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Add Sale form submitted');
        const amount = parseFloat(document.getElementById('saleAmount').value);
        const cost = parseFloat(document.getElementById('saleCost').value);
        const date = document.getElementById('saleDate').value;
        const user = auth.currentUser;

        try {
          if (user) {
            console.log('Adding sale:', { amount, cost, date });
            await firebase.firestore().addDoc(firebase.firestore().collection(db, 'sales'), {
              amount,
              cost,
              date,
              userId: user.uid,
              type: 'sale'
            });
            console.log('Sale added successfully');
            alert('Sale added successfully!');
            document.getElementById('salesForm').reset();
            loadSalesAndExpenses();
          }
        } catch (error) {
          console.error('Error adding sale:', error);
          alert('Error adding sale: ' + error.message);
        }
      });
    }

    const expensesForm = document.getElementById('expensesForm');
    if (expensesForm) {
      expensesForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Add Expense form submitted');
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        const category = document.getElementById('expenseCategory').value.trim();
        const date = document.getElementById('expenseDate').value;
        const user = auth.currentUser;

        try {
          if (user) {
            console.log('Adding expense:', { amount, category, date });
            await firebase.firestore().addDoc(firebase.firestore().collection(db, 'expenses'), {
              amount,
              category,
              date,
              userId: user.uid,
              type: 'expense'
            });
            console.log('Expense added successfully');
            alert('Expense added successfully!');
            document.getElementById('expensesForm').reset();
            loadSalesAndExpenses();
          }
        } catch (error) {
          console.error('Error adding expense:', error);
          alert('Error adding expense: ' + error.message);
        }
      });
    }

    function signOut() {
      console.log('Sign Out button clicked');
      auth.signOut().catch(error => {
        console.error('Sign out error:', error);
        alert('Error signing out: ' + error.message);
      });
    }

    function getEmbedUrl(googleMapsUrl) {
      if (!googleMapsUrl) return '';
      try {
        if (googleMapsUrl.includes('embed')) {
          return googleMapsUrl;
        }
        const coordMatch = googleMapsUrl.match(/@([-.\d]+),([-.\d]+)/) || googleMapsUrl.match(/q=([-.\d]+),([-.\d]+)/);
        if (coordMatch) {
          const lat = coordMatch[1];
          const lng = coordMatch[2];
          return `https://www.google.com/maps/embed/v1/place?q=${lat},${lng}&zoom=15`;
        }
        const placeMatch = googleMapsUrl.match(/place\/([^/]+)/);
        if (placeMatch) {
          const place = encodeURIComponent(placeMatch[1]);
          return `https://www.google.com/maps/embed/v1/place?q=${place}&zoom=15`;
        }
      } catch (error) {
        console.error('Error parsing Google Maps URL:', error);
      }
      return '';
    }

    function getCurrentLocation() {
      console.log('Send Your Location button clicked');
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            document.getElementById('googleMapsUrl').value = mapsUrl;
            console.log('Location set:', mapsUrl);
            alert('Location set successfully.');
          },
          (error) => {
            console.error('Geolocation error:', error);
            alert('Error getting location: ' + error.message + '. Please paste a Google Maps URL manually.');
          }
        );
      } else {
        alert('Geolocation is not supported by your browser. Please paste a Google Maps URL.');
      }
    }

    async function loadBusinessDetails() {
      const user = auth.currentUser;
      if (user) {
        try {
          console.log('Loading business details for user:', user.uid);
          const businessDoc = await firebase.firestore().getDoc(firebase.firestore().doc(db, 'businesses', user.uid));
          if (businessDoc.exists()) {
            const data = businessDoc.data();
            console.log('Loaded business data:', data);
            document.getElementById('businessDetails').innerHTML = `
              <p><strong>Owner Name:</strong> ${data.ownerName}</p>
              <p><strong>ID/Passport:</strong> ${data.ownerId}</p>
              <p><strong>Owner Contact Number:</strong> ${data.ownerContactNumber}</p>
              <p><strong>Residential Address:</strong> ${data.residentialAddress}</p>
              <p><strong>Business Name:</strong> ${data.businessName}</p>
              <p><strong>Business Contact Number:</strong> ${data.businessContactNumber}</p>
              <p><strong>Business Type:</strong> ${data.businessType}</p>
              <p><strong>Business Address:</strong> ${data.businessAddress}</p>
              <p><strong>Location:</strong> <a href="${data.googleMapsUrl}" target="_blank">${data.googleMapsUrl || 'Not set'}</a></p>
              <p><strong>Municipality Name:</strong> ${data.municipalityName}</p>
              <p><strong>Operation Time:</strong> ${data.operationYears} years, ${data.operationMonths} months</p>
              <p><strong>Business Account:</strong> ${data.hasBusinessAccount}${data.bankName ? ' (' + data.bankName + ')' : ''}</p>
            `;
            const mapIframe = document.getElementById('mapIframe');
            if (data.embedUrl) {
              mapIframe.src = data.embedUrl;
              mapIframe.style.display = 'block';
              console.log('Map iframe set to:', data.embedUrl);
            } else {
              mapIframe.style.display = 'none';
              console.log('No valid map URL; iframe hidden');
            }
          } else {
            console.log('No business data found; showing registration');
            showSection('businessRegistration');
          }
        } catch (error) {
          console.error('Error loading business details:', error);
          alert('Error loading business details: ' + error.message);
        }
      }
    }

    async function loadSalesAndExpenses() {
      const user = auth.currentUser;
      if (user) {
        try {
          console.log('Loading sales and expenses for user:', user.uid);
          const salesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'sales'), firebase.firestore().where('userId', '==', user.uid)));
          const expensesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'expenses'), firebase.firestore().where('userId', '==', user.uid)));
          console.log('Loaded sales:', salesSnapshot.docs.length, 'expenses:', expensesSnapshot.docs.length);
        } catch (error) {
          console.error('Error loading sales/expenses:', error);
        }
      }
    }

    async function generateReport() {
      console.log('Generate Report button clicked');
      const period = document.getElementById('reportPeriod').value;
      const user = auth.currentUser;
      if (user) {
        try {
          console.log('Generating report for period:', period);
          const salesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'sales'), firebase.firestore().where('userId', '==', user.uid)));
          const expensesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'expenses'), firebase.firestore().where('userId', '==', user.uid)));
          let sales = salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          let expenses = expensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          const now = new Date();
          let startDate, endDate;

          if (period === 'daily') {
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
          } else if (period === 'weekly') {
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
            endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 7);
          } else if (period === 'monthly') {
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
          }

          sales = sales.filter(sale => {
            const saleDate = new Date(sale.date);
            return saleDate >= startDate && saleDate < endDate;
          });

          expenses = expenses.filter(expense => {
            const expenseDate = new Date(expense.date);
            return expenseDate >= startDate && expenseDate < endDate;
          });

          const totalSales = sales.reduce((sum, sale) => sum + sale.amount, 0);
          const totalCosts = sales.reduce((sum, sale) => sum + sale.cost, 0);
          const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
          const profit = totalSales - totalCosts - totalExpenses;

          console.log('Report generated:', { totalSales, totalCosts, totalExpenses, profit });
          document.getElementById('reportOutput').innerHTML = `
            <h4>${period.charAt(0).toUpperCase() + period.slice(1)} Report</h4>
            <table>
              <tr><th>Metric</th><th>Amount</th></tr>
              <tr><td>Total Sales</td><td>R${totalSales.toFixed(2)}</td></tr>
              <tr><td>Total Costs</td><td>R${totalCosts.toFixed(2)}</td></tr>
              <tr><td>Total Expenses</td><td>R${totalExpenses.toFixed(2)}</td></tr>
              <tr><td>Profit</td><td>R${profit.toFixed(2)}</td></tr>
            </table>
          `;
        } catch (error) {
          console.error('Error generating report:', error);
          alert('Error generating report: ' + error.message);
        }
      }
    }

    async function estimateTax() {
      console.log('Estimate Tax button clicked');
      const taxMonth = document.getElementById('taxMonth').value;
      const user = auth.currentUser;
      if (user && taxMonth) {
        try {
          console.log('Estimating tax for month:', taxMonth);
          const [year, month] = taxMonth.split('-').map(Number);
          const startDate = new Date(year, month - 1, 1);
          const endDate = new Date(year, month, 1);

          const salesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'sales'), firebase.firestore().where('userId', '==', user.uid)));
          const expensesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'expenses'), firebase.firestore().where('userId', '==', user.uid)));

          let sales = salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          let expenses = expensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          sales = sales.filter(sale => {
            const saleDate = new Date(sale.date);
            return saleDate >= startDate && saleDate < endDate;
          });

          expenses = expenses.filter(expense => {
            const expenseDate = new Date(expense.date);
            return expenseDate >= startDate && expenseDate < endDate;
          });

          const totalSales = sales.reduce((sum, sale) => sum + sale.amount, 0);
          const totalCosts = sales.reduce((sum, sale) => sum + sale.cost, 0);
          const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
          const taxableIncome = totalSales - totalCosts - totalExpenses;

          const taxRate = 0.15; // Example: 15% flat rate for small businesses
          const estimatedTax = taxableIncome * taxRate;

          console.log('Tax estimated:', { taxableIncome, estimatedTax });
          document.getElementById('taxOutput').innerHTML = `
            <h4>Tax Estimation for ${taxMonth}</h4>
            <p>Taxable Income: R${taxableIncome.toFixed(2)}</p>
            <p>Estimated Tax (15%): R${estimatedTax.toFixed(2)}</p>
          `;
        } catch (error) {
          console.error('Error estimating tax:', error);
          alert('Error estimating tax: ' + error.message);
        }
      } else {
        console.warn('No tax month selected');
        alert('Please select a month.');
      }
    }

    async function exportToCSV() {
      console.log('Export to CSV button clicked');
      const user = auth.currentUser;
      if (user) {
        try {
          console.log('Exporting data to CSV');
          const salesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'sales'), firebase.firestore().where('userId', '==', user.uid)));
          const expensesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'expenses'), firebase.firestore().where('userId', '==', user.uid)));

          const sales = salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          const expenses = expensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          const csvData = [
            ['Type', 'Amount', 'Cost', 'Category', 'Date'],
            ...sales.map(sale => ['Sale', sale.amount, sale.cost, '', sale.date]),
            ...expenses.map(expense => ['Expense', expense.amount, '', expense.category, expense.date])
          ];

          const csvContent = csvData.map(row => row.join(';')).join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.setAttribute('href', url);
          link.setAttribute('download', 'business_data.csv');
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          console.log('CSV exported successfully');
        } catch (error) {
          console.error('Error exporting CSV:', error);
          alert('Error exporting CSV: ' + error.message);
        }
      }
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        for (let reg of registrations) {
          reg.unregister().then(() => {
            console.log('Service Worker unregistered');
          });
        }
      });
      window.addEventListener('load', () => {
        console.log('Registering Service Worker');
        navigator.serviceWorker.register('/sw.js').then(reg => {
          console.log('Service Worker registered:', reg.scope);
        }).catch(error => {
          console.error('Service Worker registration failed:', error);
        });
      });
    }
  </script>
</body>
</html>