<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business & Financial Tracker</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon-192x192.png">
  <link rel="apple-touch-icon" href="/icon-512x512.png">
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f3f4f6; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h2 { color: #1f2937; }
    .menu { margin: 10px 0; }
    .menu button { margin: 5px; padding: 8px 16px; background-color: #4b5563; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .menu button:hover { background-color: #374151; }
    .content { margin-top: 10px; }
    input, button, select { margin: 10px 0; padding: 8px; width: calc(100% - 18px); border: 1px solid #d1d5db; border-radius: 4px; }
    button { background-color: #4b5563; color: white; cursor: pointer; }
    button:hover { background-color: #374151; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #d1d5db; padding: 8px; text-align: left; }
    th { background-color: #f9fafb; }
    .conditional { display: none; }
    #debug { color: #666; font-size: 12px; margin-top: 10px; }
    #transactionsTable th:nth-child(1), #transactionsTable td:nth-child(1) { width: 20%; }
    #transactionsTable th:nth-child(2), #transactionsTable td:nth-child(2) { width: 20%; }
    #transactionsTable th:nth-child(3), #transactionsTable td:nth-child(3) { width: 20%; }
    #transactionsTable th:nth-child(4), #transactionsTable td:nth-child(4) { width: 40%; }
  </style>
</head>
<body>
  <div class="container">
    <section id="auth">
      <h2>Sign In</h2>
      <div id="debug"></div>
      <form id="signInForm">
        <input type="email" id="signInEmail" placeholder="Email" required><br>
        <input type="password" id="signInPassword" placeholder="Password" required><br>
        <button type="submit">Sign In</button>
      </form>
      <p>Don't have an account? <a href="#" id="showRegister">Register</a></p>
    </section>

    <section id="register" class="hidden">
      <h2>Register</h2>
      <div id="debugRegister"></div>
      <form id="registerForm">
        <input type="email" id="registerEmail" placeholder="Email" required><br>
        <input type="password" id="registerPassword" placeholder="Password" required><br>
        <button type="submit">Register</button>
      </form>
      <p>Already have an account? <a href="#" id="showSignIn">Sign In</a></p>
    </section>

    <section id="businessRegistration" class="hidden">
      <h2>Register Your Business</h2>
      <form id="businessForm">
        <input type="text" id="ownerName" placeholder="Owner Name" required><br>
        <input type="text" id="ownerId" placeholder="ID/Passport Number" required><br>
        <input type="tel" id="contactNumber" placeholder="Contact Number (e.g., +27xxxxxxxxx)" required><br>
        <input type="text" id="residentialAddress" placeholder="Residential Address" required><br>
        <input type="text" id="businessName" placeholder="Business Name" required><br>
        <input type="tel" id="businessContactNumber" placeholder="Business Contact Number (e.g., +27xxxxxxxxx)" required><br>
        <select id="businessType" required>
          <option value="" disabled selected>Select Business Type</option>
          <option value="Spaza/Tuck shop">Spaza/Tuck shop</option>
          <option value="Supermarket">Supermarket</option>
          <option value="Fast Food">Fast Food</option>
          <option value="Street hawker/vendor">Street hawker/vendor</option>
          <option value="Salon/Barber">Salon/Barber</option>
          <option value="Car Wash">Car Wash</option>
          <option value="Home Based Business">Home Based Business</option>
          <option value="Informal transport">Informal transport</option>
          <option value="Other">Other</option>
        </select><br>
        <input type="text" id="businessTypeOther" placeholder="Specify Business Type" class="conditional"><br>
        <input type="text" id="businessAddress" placeholder="Business Address" required><br>
        <input type="text" id="googleMapsUrl" placeholder="Location for Business (Google Maps URL, optional)"><br>
        <input type="text" id="municipalityName" placeholder="Municipality Name" required><br>
        <input type="number" id="operationYears" placeholder="Years in Operation" min="0" required><br>
        <input type="number" id="operationMonths" placeholder="Months in Operation" min="0" max="11" required><br>
        <select id="hasBusinessAccount" required>
          <option value="" disabled selected>Do you have a business account?</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select><br>
        <select id="bankName" class="conditional">
          <option value="" disabled selected>Select Bank</option>
          <option value="ABSA">ABSA</option>
          <option value="Bidvest">Bidvest</option>
          <option value="Capitec">Capitec</option>
          <option value="FNB">FNB</option>
          <option value="Nedbank">Nedbank</option>
          <option value="Standard Bank">Standard Bank</option>
          <option value="TymeBank">TymeBank</option>
        </select><br>
        <button type="submit">Register Business</button>
      </form>
    </section>

    <section id="dashboard" class="hidden">
      <h2>Dashboard</h2>
      <button onclick="signOut()">Sign Out</button>
      <div class="menu">
        <button onclick="showSection('businessDetails')">Business Details</button>
        <button onclick="showSection('trackSalesExpenses')">Track Sales and Expenses</button>
        <button onclick="showSection('reports')">Reports</button>
        <button onclick="showSection('taxEstimation')">Tax Estimation</button>
        <button onclick="exportToCSV()">Export Data</button>
        <button onclick="showSection('funding')">Funding</button>
      </div>
      <div class="content" id="businessDetails" style="display: none;">
        <h3>Business Details</h3>
        <div id="businessDetailsContent"></div>
      </div>
      <div class="content" id="trackSalesExpenses" style="display: none;">
        <h3>Track Sales and Expenses</h3>
        <form id="salesForm">
          <input type="number" id="saleAmount" placeholder="Sale Amount" required step="0.01"><br>
          <input type="number" id="saleCost" placeholder="Cost of Sale" required step="0.01"><br>
          <input type="date" id="saleDate" required><br>
          <button type="submit">Add Sale</button>
        </form>
        <form id="expensesForm">
          <input type="number" id="expenseAmount" placeholder="Expense Amount" required step="0.01"><br>
          <select id="expenseCategory" required>
            <option value="" disabled selected>Select Expense Category</option>
            <option value="Rent">Rent</option>
            <option value="Water & Electricity">Water & Electricity</option>
            <option value="Airtime & Data">Airtime & Data</option>
            <option value="Transport/Fuel">Transport/Fuel</option>
            <option value="Salaries/Wages">Salaries/Wages</option>
            <option value="Marketing">Marketing</option>
            <option value="Supplies">Supplies</option>
            <option value="Other">Other</option>
          </select><br>
          <input type="date" id="expenseDate" required><br>
          <button type="submit">Add Expense</button>
        </form>
        <table id="transactionsTable">
          <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Cost/Category</th>
            <th>Type</th>
          </tr>
        </table>
      </div>
      <div class="content" id="reports" style="display: none;">
        <h3>Reports</h3>
        <select id="reportPeriod">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
        </select>
        <button onclick="generateReport()">Generate Report</button>
        <div id="reportOutput"></div>
      </div>
      <div class="content" id="taxEstimation" style="display: none;">
        <h3>Tax Estimation</h3>
        <input type="month" id="taxMonth" required>
        <button onclick="estimateTax()">Estimate Tax</button>
        <div id="taxOutput"></div>
      </div>
      <div class="content" id="funding" style="display: none;">
        <h3>Funding</h3>
        <p>Funding application feature coming soon.</p>
      </div>
    </section>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjop9idbdOohdUtDvztaPmlLk-w4Xiy3c",
      authDomain: "nathibiz.firebaseapp.com",
      projectId: "nathibiz",
      storageBucket: "nathibiz.firebasestorage.app",
      messagingSenderId: "585170233799",
      appId: "1:585170233799:web:e79c3b9f334d23343b91e2"
    };

    try {
      firebase.initializeApp(firebaseConfig);
      console.log('Firebase initialized, version:', firebase.SDK_VERSION);
      document.getElementById('debug').innerText = `Firebase v${firebase.SDK_VERSION} initialized\n`;
    } catch (error) {
      console.error('Firebase init failed:', error);
      document.getElementById('debug').innerText = `Init error: ${error.message}\n`;
      alert('Firebase init failed: ' + error.message);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    function showSection(sectionId) {
      document.querySelectorAll('.content').forEach(content => content.style.display = 'none');
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = 'block';
      }
      if (sectionId === 'businessDetails') {
        loadBusinessDetails();
      } else if (sectionId === 'trackSalesExpenses') {
        loadSalesAndExpenses();
      }
      console.log(`Showing section: ${sectionId}`);
      document.getElementById('debug').innerText += `Showing section: ${sectionId}\n`;
    }

    auth.onAuthStateChanged(user => {
      console.log('Auth state changed:', user ? `User ${user?.uid}, Email: ${user?.email}` : 'No user');
      document.getElementById('debug').innerText += `Auth state: ${user ? `Signed in as ${user.email}` : 'No user'}\n`;
      if (user && user.uid && typeof user.uid === 'string') {
        const businessRef = db.collection('businesses').doc(user.uid);
        businessRef.get().then(doc => {
          console.log('Business check result:', doc.exists);
          document.getElementById('debug').innerText += `Business check: ${doc.exists ? 'Exists' : 'Not found'}\n`;
          showSection('businessDetails');
        }).catch(error => {
          console.error('Error checking business:', error);
          document.getElementById('debug').innerText += `Business check error: ${error.message}\n`;
          alert('Error checking business: ' + error.message);
          showSection('businessRegistration');
        });
      } else {
        showSection('auth');
      }
    });

    document.getElementById('showRegister').addEventListener('click', () => showSection('register'));
    document.getElementById('showSignIn').addEventListener('click', () => showSection('auth'));

    document.getElementById('signInForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signInEmail').value;
      const password = document.getElementById('signInPassword').value;
      console.log('Sign-in attempt:', { email, passwordLength: password.length });
      document.getElementById('debug').innerText += `Sign-in attempt: Email ${email}\n`;
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        console.log('Sign-in successful, UID:', userCredential.user.uid);
        document.getElementById('debug').innerText += `Sign-in successful, UID: ${userCredential.user.uid}\n`;
        auth.onAuthStateChanged(user => {
          if (user && user.uid && typeof user.uid === 'string') {
            const businessRef = db.collection('businesses').doc(user.uid);
            businessRef.get().then(doc => {
              showSection('businessDetails');
            }).catch(error => {
              console.error('Error checking business:', error);
              alert('Error checking business: ' + error.message);
              showSection('businessRegistration');
            });
          }
        });
      } catch (error) {
        console.error('Sign-in error:', error.code, error.message);
        document.getElementById('debug').innerText += `Sign-in error: ${error.message}\n`;
        alert('Sign-in failed: ' + error.message);
      }
    });

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      console.log('Registration attempt:', { email, passwordLength: password.length });
      document.getElementById('debugRegister').innerText += `Registration attempt: Email ${email}\n`;
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        console.log('Registration successful, UID:', userCredential.user.uid);
        document.getElementById('debugRegister').innerText += `Registration successful, UID: ${userCredential.user.uid}\n`;
        alert('Registration successful! Please sign in.');
        showSection('auth');
      } catch (error) {
        console.error('Registration error:', error.code, error.message);
        document.getElementById('debugRegister').innerText += `Registration error: ${error.message}\n`;
        alert('Registration failed: ' + error.message);
      }
    });

    function signOut() {
      auth.signOut().then(() => {
        console.log('Signed out successfully');
        document.getElementById('debug').innerText += 'Signed out successfully\n';
        showSection('auth');
      }).catch(error => {
        console.error('Sign out error:', error);
        document.getElementById('debug').innerText += `Sign out error: ${error.message}\n`;
        alert('Error signing out: ' + error.message);
      });
    }

    function getCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            document.getElementById('googleMapsUrl').value = mapsUrl;
            alert('Location set in Location for Business field (for reference only).');
          },
          (error) => {
            console.error('Geolocation error:', error);
            alert('Error getting location: ' + error.message + '. Please paste a Google Maps URL manually.');
          }
        );
      } else {
        alert('Geolocation is not supported by your browser. Please paste a Google Maps URL.');
      }
    }

    document.getElementById('businessType').addEventListener('change', (e) => {
      const otherField = document.getElementById('businessTypeOther');
      otherField.classList.toggle('conditional', e.target.value !== 'Other');
      otherField.required = e.target.value === 'Other';
    });

    document.getElementById('hasBusinessAccount').addEventListener('change', (e) => {
      const bankField = document.getElementById('bankName');
      bankField.classList.toggle('conditional', e.target.value !== 'Yes');
      bankField.required = e.target.value === 'Yes';
    });

    document.getElementById('businessForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const ownerName = document.getElementById('ownerName').value;
      const ownerId = document.getElementById('ownerId').value;
      const contactNumber = document.getElementById('contactNumber').value;
      const residentialAddress = document.getElementById('residentialAddress').value;
      const businessName = document.getElementById('businessName').value;
      const businessContactNumber = document.getElementById('businessContactNumber').value;
      let businessType = document.getElementById('businessType').value;
      const businessTypeOther = document.getElementById('businessTypeOther').value;
      const businessAddress = document.getElementById('businessAddress').value;
      const googleMapsUrl = document.getElementById('googleMapsUrl').value;
      const municipalityName = document.getElementById('municipalityName').value;
      const operationYears = parseInt(document.getElementById('operationYears').value);
      const operationMonths = parseInt(document.getElementById('operationMonths').value);
      const hasBusinessAccount = document.getElementById('hasBusinessAccount').value;
      const bankName = document.getElementById('bankName').value;
      const user = auth.currentUser;

      if (businessType === 'Other' && !businessTypeOther) {
        alert('Please specify the business type.');
        return;
      }
      if (hasBusinessAccount === 'Yes' && !bankName) {
        alert('Please select a bank.');
        return;
      }
      if (!/^\+?\d{10,15}$/.test(contactNumber)) {
        alert('Please enter a valid contact number (e.g., +27xxxxxxxxx).');
        return;
      }
      if (!/^\+?\d{10,15}$/.test(businessContactNumber)) {
        alert('Please enter a valid business contact number (e.g., +27xxxxxxxxx).');
        return;
      }

      if (user) {
        await db.collection('businesses').doc(user.uid).set({
          ownerName,
          ownerId,
          contactNumber,
          residentialAddress,
          businessName,
          businessContactNumber,
          businessType: businessType === 'Other' ? businessTypeOther : businessType,
          businessAddress,
          googleMapsUrl,
          municipalityName,
          operationYears,
          operationMonths,
          hasBusinessAccount,
          bankName: hasBusinessAccount === 'Yes' ? bankName : null,
          userId: user.uid
        });
        alert('Business registered successfully!');
        showSection('businessDetails');
      } else {
        alert('Please sign in to register a business.');
      }
    });

    async function loadBusinessDetails() {
      const user = auth.currentUser;
      if (user) {
        const businessDoc = await db.collection('businesses').doc(user.uid).get();
        if (businessDoc.exists) {
          const data = businessDoc.data();
          document.getElementById('businessDetailsContent').innerHTML = `
            <p><strong>Owner Name:</strong> ${data.ownerName}</p>
            <p><strong>ID/Passport:</strong> ${data.ownerId}</p>
            <p><strong>Contact Number:</strong> ${data.contactNumber}</p>
            <p><strong>Residential Address:</strong> ${data.residentialAddress}</p>
            <p><strong>Business Name:</strong> ${data.businessName}</p>
            <p><strong>Business Contact Number:</strong> ${data.businessContactNumber}</p>
            <p><strong>Business Type:</strong> ${data.businessType}</p>
            <p><strong>Business Address:</strong> ${data.businessAddress}</p>
            <p><strong>Location URL:</strong> <a href="${data.googleMapsUrl}" target="_blank">${data.googleMapsUrl || 'Not set'}</a></p>
            <p><strong>Municipality Name:</strong> ${data.municipalityName}</p>
            <p><strong>Operation Time:</strong> ${data.operationYears} years, ${data.operationMonths} months</p>
            <p><strong>Business Account:</strong> ${data.hasBusinessAccount}${data.bankName ? ' (' + data.bankName + ')' : ''}</p>
          `;
        } else {
          showSection('businessRegistration');
        }
      }
    }

    async function loadSalesAndExpenses() {
      const user = auth.currentUser;
      if (user) {
        const salesSnapshot = await db.collection('sales').where('userId', '==', user.uid).get();
        const expensesSnapshot = await db.collection('expenses').where('userId', '==', user.uid).get();
        const table = document.getElementById('transactionsTable');
        table.innerHTML = `
          <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Cost/Category</th>
            <th>Type</th>
          </tr>
        `;

        salesSnapshot.docs.forEach(doc => {
          const data = doc.data();
          const row = table.insertRow();
          row.innerHTML = `
            <td>${data.date}</td>
            <td>R${data.amount.toFixed(2)}</td>
            <td>R${data.cost.toFixed(2)}</td>
            <td>Sale</td>
          `;
        });

        expensesSnapshot.docs.forEach(doc => {
          const data = doc.data();
          const row = table.insertRow();
          row.innerHTML = `
            <td>${data.date}</td>
            <td>R${data.amount.toFixed(2)}</td>
            <td>${data.category}</td>
            <td>Expense</td>
          `;
        });
      }
    }

    document.getElementById('salesForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('saleAmount').value);
      const cost = parseFloat(document.getElementById('saleCost').value);
      const date = document.getElementById('saleDate').value;
      const user = auth.currentUser;

      if (user) {
        await db.collection('sales').add({
          amount,
          cost,
          date,
          userId: user.uid,
          type: 'sale'
        });
        alert('Sale added successfully!');
        document.getElementById('salesForm').reset();
        loadSalesAndExpenses();
      }
    });

    document.getElementById('expensesForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      const category = document.getElementById('expenseCategory').value;
      const date = document.getElementById('expenseDate').value;
      const user = auth.currentUser;

      if (user) {
        await db.collection('expenses').add({
          amount,
          category,
          date,
          userId: user.uid,
          type: 'expense'
        });
        alert('Expense added successfully!');
        document.getElementById('expensesForm').reset();
        loadSalesAndExpenses();
      }
    });

    async function generateReport() {
      const period = document.getElementById('reportPeriod').value;
      const user = auth.currentUser;
      if (user) {
        const salesSnapshot = await db.collection('sales').where('userId', '==', user.uid).get();
        const expensesSnapshot = await db.collection('expenses').where('userId', '==', user.uid).get();
        let sales = salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        let expenses = expensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const now = new Date();
        let startDate, endDate;

        if (period === 'daily') {
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        } else if (period === 'weekly') {
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 7);
        } else if (period === 'monthly') {
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        }

        sales = sales.filter(sale => {
          const saleDate = new Date(sale.date);
          return saleDate >= startDate && saleDate < endDate;
        });

        expenses = expenses.filter(expense => {
          const expenseDate = new Date(expense.date);
          return expenseDate >= startDate && expenseDate < endDate;
        });

        const totalSales = sales.reduce((sum, sale) => sum + sale.amount, 0);
        const totalCosts = sales.reduce((sum, sale) => sum + sale.cost, 0);
        const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        const profit = totalSales - totalCosts - totalExpenses;

        document.getElementById('reportOutput').innerHTML = `
          <h4>${period.charAt(0).toUpperCase() + period.slice(1)} Report</h4>
          <table>
            <tr><th>Metric</th><th>Amount</th></tr>
            <tr><td>Total Sales</td><td>R${totalSales.toFixed(2)}</td></tr>
            <tr><td>Total Costs</td><td>R${totalCosts.toFixed(2)}</td></tr>
            <tr><td>Total Expenses</td><td>R${totalExpenses.toFixed(2)}</td></tr>
            <tr><td>Profit</td><td>R${profit.toFixed(2)}</td></tr>
          </table>
        `;
      }
    }

    async function estimateTax() {
      const taxMonth = document.getElementById('taxMonth').value;
      const user = auth.currentUser;
      if (user && taxMonth) {
        const [year, month] = taxMonth.split('-').map(Number);
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 1);

        const salesSnapshot = await db.collection('sales').where('userId', '==', user.uid).get();
        const expensesSnapshot = await db.collection('expenses').where('userId', '==', user.uid).get();

        let sales = salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        let expenses = expensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        sales = sales.filter(sale => {
          const saleDate = new Date(sale.date);
          return saleDate >= startDate && saleDate < endDate;
        });

        expenses = expenses.filter(expense => {
          const expenseDate = new Date(expense.date);
          return expenseDate >= startDate && expenseDate < endDate;
        });

        const totalSales = sales.reduce((sum, sale) => sum + sale.amount, 0);
        const totalCosts = sales.reduce((sum, sale) => sum + sale.cost, 0);
        const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        const taxableIncome = totalSales - totalCosts - totalExpenses;

        const taxRate = 0.15; // Example: 15% flat rate for small businesses
        const estimatedTax = taxableIncome * taxRate;

        document.getElementById('taxOutput').innerHTML = `
          <h4>Tax Estimation for ${taxMonth}</h4>
          <p>Taxable Income: R${taxableIncome.toFixed(2)}</p>
          <p>Estimated Tax (15%): R${estimatedTax.toFixed(2)}</p>
        `;
      } else {
        alert('Please select a month.');
      }
    }

    async function exportToCSV() {
      const user = auth.currentUser;
      if (!user) {
        alert('Please sign in to export data.');
        return;
      }

      try {
        const salesSnapshot = await db.collection('sales').where('userId', '==', user.uid).get();
        const expensesSnapshot = await db.collection('expenses').where('userId', '==', user.uid).get();

        const sales = salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const expenses = expensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const now = new Date();
        let startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        let endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);

        let filteredSales = sales.filter(sale => {
          const saleDate = new Date(sale.date);
          return saleDate >= startDate && saleDate < endDate;
        });

        let filteredExpenses = expenses.filter(expense => {
          const expenseDate = new Date(expense.date);
          return expenseDate >= startDate && expenseDate < endDate;
        });

        const totalSales = filteredSales.reduce((sum, sale) => sum + sale.amount, 0) || 0;
        const totalCosts = filteredSales.reduce((sum, sale) => sum + sale.cost, 0) || 0;
        const income = totalSales - totalCosts;
        const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0) || 0;
        const profit = income - totalExpenses;

        const csvData = [
          ['Date', 'Sales', 'Cost of Sales', 'Income', 'Expenses', 'Profit']
        ];

        csvData.push([
          now.toISOString().split('T')[0],
          totalSales.toFixed(2),
          totalCosts.toFixed(2),
          income.toFixed(2),
          filteredExpenses.length > 0 ? filteredExpenses.map(exp => `${exp.category}: R${exp.amount.toFixed(2)}`).join(', ') : 'None',
          profit.toFixed(2)
        ]);

        const csvContent = csvData.map(row => row.join(';')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'business_data.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log('CSV exported successfully');
        document.getElementById('debug').innerText += 'CSV exported successfully\n';
      } catch (error) {
        console.error('Error exporting CSV:', error);
        document.getElementById('debug').innerText += `Error exporting CSV: ${error.message}\n`;
        alert('Failed to export CSV: ' + error.message);
      }
    }

    if ('serviceWorker' in navigator) {
      // window.addEventListener('load', () => {
      //   navigator.serviceWorker.register('/sw.js')
      //     .then(registration => {
      //       console.log('Service Worker registered with scope:', registration.scope);
      //       document.getElementById('debug').innerText += `Service Worker registered: ${registration.scope}\n`;
      //     })
      //     .catch(error => {
      //       console.error('Service Worker registration failed:', error);
      //       document.getElementById('debug').innerText += `Service Worker error: ${error.message}\n`;
      //     });
      // });
    }
  </script>
</body>
</html>