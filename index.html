<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business & Financial Tracker</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon-192x192.png">
  <link rel="apple-touch-icon" href="/icon-512x512.png">
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f3f4f6; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h2, h3 { color: #1f2937; }
    input, button, select { margin: 10px 0; padding: 8px; width: calc(100% - 18px); border: 1px solid #d1d5db; border-radius: 4px; }
    button { background-color: #4b5563; color: white; cursor: pointer; }
    button:hover { background-color: #374151; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #d1d5db; padding: 8px; text-align: left; }
    th { background-color: #f9fafb; }
    .conditional { display: none; }
    #debug { color: #666; font-size: 12px; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <section id="auth">
      <h2>Sign In</h2>
      <div id="debug"></div>
      <form id="signInForm">
        <input type="email" id="signInEmail" placeholder="Email" required><br>
        <input type="password" id="signInPassword" placeholder="Password" required><br>
        <button type="submit">Sign In</button>
      </form>
      <p>Don't have an account? <a href="#" id="showRegister">Register</a></p>
    </section>

    <section id="register" class="hidden">
      <h2>Register</h2>
      <div id="debugRegister"></div>
      <form id="registerForm">
        <input type="email" id="registerEmail" placeholder="Email" required><br>
        <input type="password" id="registerPassword" placeholder="Password" required><br>
        <button type="submit">Register</button>
      </form>
      <p>Already have an account? <a href="#" id="showSignIn">Sign In</a></p>
    </section>

    <section id="businessRegistration" class="hidden">
      <h2>Register Your Business</h2>
      <form id="businessForm">
        <input type="text" id="businessName" placeholder="Business Name" required><br>
        <select id="businessType" required>
          <option value="" disabled selected>Select Business Type</option>
          <option value="Spaza/Tuck shop">Spaza/Tuck shop</option>
          <option value="Supermarket">Supermarket</option>
          <option value="Fast Food">Fast Food</option>
          <option value="Street hawker/vendor">Street hawker/vendor</option>
          <option value="Salon/Barber">Salon/Barber</option>
          <option value="Car Wash">Car Wash</option>
          <option value="Home Based Business">Home Based Business</option>
          <option value="Informal transport">Informal transport</option>
          <option value="Other">Other</option>
        </select><br>
        <input type="text" id="businessTypeOther" placeholder="Specify Business Type" class="conditional"><br>
        <input type="text" id="ownerName" placeholder="Owner Name" required><br>
        <input type="text" id="ownerId" placeholder="ID/Passport Number" required><br>
        <input type="tel" id="contactNumber" placeholder="Contact Number (e.g., +27xxxxxxxxx)" required><br>
        <input type="text" id="physicalAddress" placeholder="Physical Address" required><br>
        <input type="text" id="postalAddress" placeholder="Postal Address" required><br>
        <input type="text" id="googleMapsUrl" placeholder="Google Maps URL (e.g., https://www.google.com/maps/place/...)"><br>
        <button type="button" onclick="getCurrentLocation()">Send Your Location</button><br>
        <input type="number" id="operationYears" placeholder="Years in Operation" min="0" required><br>
        <input type="number" id="operationMonths" placeholder="Months in Operation" min="0" max="11" required><br>
        <select id="hasBusinessAccount" required>
          <option value="" disabled selected>Do you have a business account?</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select><br>
        <select id="bankName" class="conditional">
          <option value="" disabled selected>Select Bank</option>
          <option value="ABSA">ABSA</option>
          <option value="Bidvest">Bidvest</option>
          <option value="Capitec">Capitec</option>
          <option value="FNB">FNB</option>
          <option value="Nedbank">Nedbank</option>
          <option value="Standard Bank">Standard Bank</option>
          <option value="TymeBank">TymeBank</option>
        </select><br>
        <button type="submit">Register Business</button>
      </form>
    </section>

    <section id="dashboard" class="hidden">
      <h2>Dashboard</h2>
      <button onclick="signOut()">Sign Out</button>
      <h3>Business Details</h3>
      <div id="businessDetails"></div>
      <div id="businessMap" style="margin-top: 20px;">
        <iframe id="mapIframe" width="100%" height="300" frameborder="0" style="border:0" allowfullscreen></iframe>
      </div>
      <h3>Track Sales and Expenses</h3>
      <form id="salesForm">
        <input type="number" id="saleAmount" placeholder="Sale Amount" required step="0.01"><br>
        <input type="number" id="saleCost" placeholder="Cost of Sale" required step="0.01"><br>
        <input type="date" id="saleDate" required><br>
        <button type="submit">Add Sale</button>
      </form>
      <form id="expensesForm">
        <input type="number" id="expenseAmount" placeholder="Expense Amount" required step="0.01"><br>
        <input type="text" id="expenseCategory" placeholder="Category (e.g., Utilities)" required><br>
        <input type="date" id="expenseDate" required><br>
        <button type="submit">Add Expense</button>
      </form>
      <h3>Reports</h3>
      <select id="reportPeriod">
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
      </select>
      <button onclick="generateReport()">Generate Report</button>
      <div id="reportOutput"></div>
      <h3>Tax Estimation</h3>
      <input type="month" id="taxMonth" required>
      <button onclick="estimateTax()">Estimate Tax</button>
      <div id="taxOutput"></div>
      <h3>Export Data</h3>
      <button onclick="exportToCSV()">Export to CSV</button>
      <h3>Funding</h3>
      <p>Funding application feature coming soon.</p>
    </section>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjop9idbdOohdUtDvztaPmlLk-w4Xiy3c",
      authDomain: "nathibiz.firebaseapp.com",
      projectId: "nathibiz",
      storageBucket: "nathibiz.firebasestorage.app",
      messagingSenderId: "585170233799",
      appId: "1:585170233799:web:e79c3b9f334d23343b91e2"
    };

    try {
      firebase.initializeApp(firebaseConfig);
      console.log('Firebase initialized, version:', firebase.SDK_VERSION);
      document.getElementById('debug').innerText = `Firebase v${firebase.SDK_VERSION} initialized\n`;
    } catch (error) {
      console.error('Firebase init failed:', error);
      document.getElementById('debug').innerText = `Init error: ${error.message}\n`;
      alert('Firebase init failed: ' + error.message);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    function showSection(sectionId) {
      document.querySelectorAll('section').forEach(section => section.classList.add('hidden'));
      document.getElementById(sectionId).classList.remove('hidden');
      if (sectionId === 'dashboard') {
        loadBusinessDetails();
        loadSalesAndExpenses();
      }
      console.log(`Showing section: ${sectionId}`);
      document.getElementById('debug').innerText += `Showing section: ${sectionId}\n`;
    }

    auth.onAuthStateChanged(user => {
      console.log('Auth state changed:', user ? `User ${user?.uid}, Email: ${user?.email}` : 'No user');
      document.getElementById('debug').innerText += `Auth state: ${user ? `Signed in as ${user.email}` : 'No user'}\n`;
      if (user && user.uid) {
        const businessRef = firebase.firestore().doc(db, 'businesses', user.uid);
        firebase.firestore().getDoc(businessRef).then(doc => {
          console.log('Business check result:', doc.exists());
          document.getElementById('debug').innerText += `Business check: ${doc.exists() ? 'Exists' : 'Not found'}\n`;
          showSection(doc.exists() ? 'dashboard' : 'businessRegistration');
        }).catch(error => {
          console.error('Error checking business:', error);
          document.getElementById('debug').innerText += `Business check error: ${error.message}\n`;
          alert('Error checking business: ' + error.message);
          showSection('businessRegistration');
        });
      } else {
        showSection('auth');
      }
    });

    document.getElementById('showRegister').addEventListener('click', () => showSection('register'));
    document.getElementById('showSignIn').addEventListener('click', () => showSection('auth'));

    document.getElementById('signInForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signInEmail').value;
      const password = document.getElementById('signInPassword').value;
      console.log('Sign-in attempt:', { email, passwordLength: password.length });
      document.getElementById('debug').innerText += `Sign-in attempt: Email ${email}\n`;
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        console.log('Sign-in successful, UID:', userCredential.user.uid);
        document.getElementById('debug').innerText += `Sign-in successful, UID: ${userCredential.user.uid}\n`;
        // Ensure state change is handled
        auth.onAuthStateChanged(user => {
          if (user) {
            const businessRef = firebase.firestore().doc(db, 'businesses', user.uid);
            firebase.firestore().getDoc(businessRef).then(doc => {
              showSection(doc.exists() ? 'dashboard' : 'businessRegistration');
            }).catch(error => {
              console.error('Error checking business:', error);
              alert('Error checking business: ' + error.message);
              showSection('businessRegistration');
            });
          }
        });
      } catch (error) {
        console.error('Sign-in error:', error.code, error.message);
        document.getElementById('debug').innerText += `Sign-in error: ${error.message}\n`;
        alert('Sign-in failed: ' + error.message);
      }
    });

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      console.log('Registration attempt:', { email, passwordLength: password.length });
      document.getElementById('debugRegister').innerText += `Registration attempt: Email ${email}\n`;
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        console.log('Registration successful, UID:', userCredential.user.uid);
        document.getElementById('debugRegister').innerText += `Registration successful, UID: ${userCredential.user.uid}\n`;
        alert('Registration successful! Please sign in.');
        showSection('auth');
      } catch (error) {
        console.error('Registration error:', error.code, error.message);
        document.getElementById('debugRegister').innerText += `Registration error: ${error.message}\n`;
        alert('Registration failed: ' + error.message);
      }
    });

    function signOut() {
      auth.signOut().then(() => {
        console.log('Signed out successfully');
        document.getElementById('debug').innerText += 'Signed out successfully\n';
        showSection('auth');
      }).catch(error => {
        console.error('Sign out error:', error);
        document.getElementById('debug').innerText += `Sign out error: ${error.message}\n`;
        alert('Error signing out: ' + error.message);
      });
    }

    // Google Maps handling
    function getEmbedUrl(googleMapsUrl) {
      if (!googleMapsUrl) return '';
      try {
        if (googleMapsUrl.includes('embed')) {
          return googleMapsUrl;
        }
        const coordMatch = googleMapsUrl.match(/@([-.\d]+),([-.\d]+)/) || googleMapsUrl.match(/q=([-.\d]+),([-.\d]+)/);
        if (coordMatch) {
          const lat = coordMatch[1];
          const lng = coordMatch[2];
          return `https://www.google.com/maps/embed/v1/place?q=${lat},${lng}&zoom=15`;
        }
        const placeMatch = googleMapsUrl.match(/place\/([^/]+)/);
        if (placeMatch) {
          const place = encodeURIComponent(placeMatch[1]);
          return `https://www.google.com/maps/embed/v1/place?q=${place}&zoom=15`;
        }
      } catch (error) {
        console.error('Error parsing Google Maps URL:', error);
      }
      return '';
    }

    function getCurrentLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            document.getElementById('googleMapsUrl').value = mapsUrl;
            alert('Location set in Google Maps URL field.');
          },
          (error) => {
            console.error('Geolocation error:', error);
            alert('Error getting location: ' + error.message + '. Please paste a Google Maps URL manually.');
          }
        );
      } else {
        alert('Geolocation is not supported by your browser. Please paste a Google Maps URL.');
      }
    }

    // Business form logic
    document.getElementById('businessType').addEventListener('change', (e) => {
      const otherField = document.getElementById('businessTypeOther');
      otherField.classList.toggle('conditional', e.target.value !== 'Other');
      otherField.required = e.target.value === 'Other';
    });

    document.getElementById('hasBusinessAccount').addEventListener('change', (e) => {
      const bankField = document.getElementById('bankName');
      bankField.classList.toggle('conditional', e.target.value !== 'Yes');
      bankField.required = e.target.value === 'Yes';
    });

    document.getElementById('businessForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const businessName = document.getElementById('businessName').value;
      let businessType = document.getElementById('businessType').value;
      const businessTypeOther = document.getElementById('businessTypeOther').value;
      const ownerName = document.getElementById('ownerName').value;
      const ownerId = document.getElementById('ownerId').value;
      const contactNumber = document.getElementById('contactNumber').value;
      const physicalAddress = document.getElementById('physicalAddress').value;
      const postalAddress = document.getElementById('postalAddress').value;
      let googleMapsUrl = document.getElementById('googleMapsUrl').value;
      const operationYears = parseInt(document.getElementById('operationYears').value);
      const operationMonths = parseInt(document.getElementById('operationMonths').value);
      const hasBusinessAccount = document.getElementById('hasBusinessAccount').value;
      const bankName = document.getElementById('bankName').value;
      const user = auth.currentUser;

      if (businessType === 'Other' && !businessTypeOther) {
        alert('Please specify the business type.');
        return;
      }
      if (hasBusinessAccount === 'Yes' && !bankName) {
        alert('Please select a bank.');
        return;
      }
      if (!/^\+?\d{10,15}$/.test(contactNumber)) {
        alert('Please enter a valid contact number (e.g., +27xxxxxxxxx).');
        return;
      }

      const embedUrl = getEmbedUrl(googleMapsUrl);
      if (googleMapsUrl && !embedUrl) {
        console.warn('Invalid Google Maps URL:', googleMapsUrl);
      }

      if (user) {
        await firebase.firestore().setDoc(firebase.firestore().doc(db, 'businesses', user.uid), {
          businessName,
          businessType: businessType === 'Other' ? businessTypeOther : businessType,
          ownerName,
          ownerId,
          contactNumber,
          physicalAddress,
          postalAddress,
          googleMapsUrl,
          embedUrl,
          operationYears,
          operationMonths,
          hasBusinessAccount,
          bankName: hasBusinessAccount === 'Yes' ? bankName : null,
          userId: user.uid
        });
        alert('Business registered successfully!');
        showSection('dashboard');
      } else {
        alert('Please sign in to register a business.');
      }
    });

    async function loadBusinessDetails() {
      const user = auth.currentUser;
      if (user) {
        const businessDoc = await firebase.firestore().getDoc(firebase.firestore().doc(db, 'businesses', user.uid));
        if (businessDoc.exists()) {
          const data = businessDoc.data();
          document.getElementById('businessDetails').innerHTML = `
            <p><strong>Business Name:</strong> ${data.businessName}</p>
            <p><strong>Business Type:</strong> ${data.businessType}</p>
            <p><strong>Owner:</strong> ${data.ownerName}</p>
            <p><strong>ID/Passport:</strong> ${data.ownerId}</p>
            <p><strong>Contact Number:</strong> ${data.contactNumber}</p>
            <p><strong>Physical Address:</strong> ${data.physicalAddress}</p>
            <p><strong>Postal Address:</strong> ${data.postalAddress}</p>
            <p><strong>Location:</strong> <a href="${data.googleMapsUrl}" target="_blank">${data.googleMapsUrl || 'Not set'}</a></p>
            <p><strong>Operation Time:</strong> ${data.operationYears} years, ${data.operationMonths} months</p>
            <p><strong>Business Account:</strong> ${data.hasBusinessAccount}${data.bankName ? ' (' + data.bankName + ')' : ''}</p>
          `;
          const mapIframe = document.getElementById('mapIframe');
          if (data.embedUrl) {
            mapIframe.src = data.embedUrl;
            mapIframe.style.display = 'block';
            console.log('Map iframe set to:', data.embedUrl);
          } else {
            mapIframe.style.display = 'none';
            console.log('No valid map URL; iframe hidden');
          }
        } else {
          showSection('businessRegistration');
        }
      }
    }

    document.getElementById('salesForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('saleAmount').value);
      const cost = parseFloat(document.getElementById('saleCost').value);
      const date = document.getElementById('saleDate').value;
      const user = auth.currentUser;

      if (user) {
        await firebase.firestore().addDoc(firebase.firestore().collection(db, 'sales'), {
          amount,
          cost,
          date,
          userId: user.uid,
          type: 'sale'
        });
        alert('Sale added successfully!');
        document.getElementById('salesForm').reset();
        loadSalesAndExpenses();
      }
    });

    document.getElementById('expensesForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      const category = document.getElementById('expenseCategory').value;
      const date = document.getElementById('expenseDate').value;
      const user = auth.currentUser;

      if (user) {
        await firebase.firestore().addDoc(firebase.firestore().collection(db, 'expenses'), {
          amount,
          category,
          date,
          userId: user.uid,
          type: 'expense'
        });
        alert('Expense added successfully!');
        document.getElementById('expensesForm').reset();
        loadSalesAndExpenses();
      }
    });

    async function loadSalesAndExpenses() {
      const user = auth.currentUser;
      if (user) {
        const salesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'sales'), firebase.firestore().where('userId', '==', user.uid)));
        const expensesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'expenses'), firebase.firestore().where('userId', '==', user.uid)));
        // Display logic can be added if needed
      }
    }

    async function generateReport() {
      const period = document.getElementById('reportPeriod').value;
      const user = auth.currentUser;
      if (user) {
        const salesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'sales'), firebase.firestore().where('userId', '==', user.uid)));
        const expensesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'expenses'), firebase.firestore().where('userId', '==', user.uid)));
        let sales = salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        let expenses = expensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const now = new Date();
        let startDate, endDate;

        if (period === 'daily') {
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        } else if (period === 'weekly') {
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 7);
        } else if (period === 'monthly') {
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        }

        sales = sales.filter(sale => {
          const saleDate = new Date(sale.date);
          return saleDate >= startDate && saleDate < endDate;
        });

        expenses = expenses.filter(expense => {
          const expenseDate = new Date(expense.date);
          return expenseDate >= startDate && expenseDate < endDate;
        });

        const totalSales = sales.reduce((sum, sale) => sum + sale.amount, 0);
        const totalCosts = sales.reduce((sum, sale) => sum + sale.cost, 0);
        const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        const profit = totalSales - totalCosts - totalExpenses;

        document.getElementById('reportOutput').innerHTML = `
          <h4>${period.charAt(0).toUpperCase() + period.slice(1)} Report</h4>
          <table>
            <tr><th>Metric</th><th>Amount</th></tr>
            <tr><td>Total Sales</td><td>R${totalSales.toFixed(2)}</td></tr>
            <tr><td>Total Costs</td><td>R${totalCosts.toFixed(2)}</td></tr>
            <tr><td>Total Expenses</td><td>R${totalExpenses.toFixed(2)}</td></tr>
            <tr><td>Profit</td><td>R${profit.toFixed(2)}</td></tr>
          </table>
        `;
      }
    }

    async function estimateTax() {
      const taxMonth = document.getElementById('taxMonth').value;
      const user = auth.currentUser;
      if (user && taxMonth) {
        const [year, month] = taxMonth.split('-').map(Number);
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 1);

        const salesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'sales'), firebase.firestore().where('userId', '==', user.uid)));
        const expensesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'expenses'), firebase.firestore().where('userId', '==', user.uid)));

        let sales = salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        let expenses = expensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        sales = sales.filter(sale => {
          const saleDate = new Date(sale.date);
          return saleDate >= startDate && saleDate < endDate;
        });

        expenses = expenses.filter(expense => {
          const expenseDate = new Date(expense.date);
          return expenseDate >= startDate && expenseDate < endDate;
        });

        const totalSales = sales.reduce((sum, sale) => sum + sale.amount, 0);
        const totalCosts = sales.reduce((sum, sale) => sum + sale.cost, 0);
        const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        const taxableIncome = totalSales - totalCosts - totalExpenses;

        const taxRate = 0.15; // Example: 15% flat rate for small businesses
        const estimatedTax = taxableIncome * taxRate;

        document.getElementById('taxOutput').innerHTML = `
          <h4>Tax Estimation for ${taxMonth}</h4>
          <p>Taxable Income: R${taxableIncome.toFixed(2)}</p>
          <p>Estimated Tax (15%): R${estimatedTax.toFixed(2)}</p>
        `;
      } else {
        alert('Please select a month.');
      }
    }

    async function exportToCSV() {
      const user = auth.currentUser;
      if (user) {
        const salesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'sales'), firebase.firestore().where('userId', '==', user.uid)));
        const expensesSnapshot = await firebase.firestore().getDocs(firebase.firestore().query(firebase.firestore().collection(db, 'expenses'), firebase.firestore().where('userId', '==', user.uid)));

        const sales = salesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const expenses = expensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const csvData = [
          ['Type', 'Amount', 'Cost', 'Category', 'Date'],
          ...sales.map(sale => ['Sale', sale.amount, sale.cost, '', sale.date]),
          ...expenses.map(expense => ['Expense', expense.amount, '', expense.category, expense.date])
        ];

        const csvContent = csvData.map(row => row.join(';')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'business_data.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    if ('serviceWorker' in navigator) {
      // window.addEventListener('load', () => {
      //   navigator.serviceWorker.register('/sw.js')
      //     .then(registration => {
      //       console.log('Service Worker registered with scope:', registration.scope);
      //       document.getElementById('debug').innerText += `Service Worker registered: ${registration.scope}\n`;
      //     })
      //     .catch(error => {
      //       console.error('Service Worker registration failed:', error);
      //       document.getElementById('debug').innerText += `Service Worker error: ${error.message}\n`;
      //     });
      // });
    }
  </script>
</body>
</html>